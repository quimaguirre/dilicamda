---
title: "CMap Drug Safety Challenge: Gene test across samples of all cell lines (mixing less and most)"
author: "Joaquim Aguirre-Plans"
date: "April 29, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
### Install packages ###
# Install Bioconductor to install "rhdf5", a dependency of cmapR
#install.packages("BiocManager")
#BiocManager::install("rhdf5", version = "3.8")
# cmapR has been installed manually by downloading the package on github (https://github.com/cmap/cmapR) and running the following commands:
# R CMD build cmapR
# R CMD check cmapR_1.0.1.tar.gz
#install.packages("/home/quim/R/x86_64-pc-linux-gnu-library/3.5/cmapR_1.0.1.tar.gz", type="source", repos=NULL)
# Install GGPlot2 and its dependencies
#install.packages('Rcpp', dependencies = TRUE)
#install.packages('ggplot2', dependencies = TRUE)
#install.packages('data.table', dependencies = TRUE)
# Install ggbiplot to plot the PCA
#library(devtools)
#install_github("vqv/ggbiplot")

### Load packages ###
library(cmapR)
library(ggplot2)
library(ggbiplot)
library(gplots) # For heatmap.2
library(ComplexHeatmap) # For Heatmap()
library(circlize) # For Heatmap()
```

```{r, include=FALSE}
### Define files ###
#setwd("/sbi/users/interchange/emre/quim/camda")
drugs_file <- "/home/quim/PHD/Projects/camda/camda_data/CAMDA_l1000_1314compounds-pert_iname.rda"
drug_info_file <- "/sbi/users/interchange/emre/quim/camda/CAMDA_l1000_1314compounds-info.rda"
dilirank_file <- "/home/quim/PHD/Projects/camda/camda_data/CAMDA_l1000_1314compounds-dilirank.v2.rda"
expression_file <- "/sbi/users/interchange/emre/quim/camda/CAMDA_l1000_1314compounds-GSE92742_Level5_gct.rda"
gene_info_file <- "/home/quim/PHD/Projects/camda/additional_data/GSE92742_Broad_LINCS_gene_info.txt"
phenotype2gene_file <- "/home/quim/PHD/Projects/camda/guildify_data/phenotype2gene.tsv"
```


## Load files

First we load the R objects needed.

```{r}
load(drugs_file)
load(drug_info_file)
load(dilirank_file)
load(expression_file) # Requires cmapR
```

We load the gene information file as well, containing the landmark genes [More info](https://clue.io/connectopedia/l1000_gene_space).

```{r}
gene_info_df <- read.csv(gene_info_file, header=TRUE, sep="\t")
landmark_genes <- gene_info_df$pr_gene_id[gene_info_df$pr_is_lm==1]
```

I subset the DILIConcern data by those drugs that have the same label in the columns DILIConcern and vDILIConcern.

```{r}
drank.sel$DILIConcern[drank.sel$DILIConcern == "No-DILI-concern"] <- "No-DILI-Concern" # Correct the 4 entries with lowercase concern
# We remove the first letter from vDILIConcern entries (except Ambiguous)
drank.sel$vDILIConcern[drank.sel$vDILIConcern != "Ambiguous DILI-concern"] <- sub('.', '', drank.sel$vDILIConcern[drank.sel$vDILIConcern != "Ambiguous DILI-concern"])
# We subset the table by those drugs that have the same value in vDILIConcern and DILIConcern columns
dilirank_df <- drank.sel[drank.sel$vDILIConcern == drank.sel$DILIConcern,]
most_concern_drugs <- dilirank_df$pert_iname[dilirank_df$DILIConcern == "Most-DILI-Concern"]
less_concern_drugs <- dilirank_df$pert_iname[dilirank_df$DILIConcern == "Less-DILI-Concern"]
most_less_concern_drugs <- union(most_concern_drugs, less_concern_drugs)
no_concern_drugs <- dilirank_df$pert_iname[dilirank_df$DILIConcern == "No-DILI-Concern"]
```

We have `r length(dilirank_df$pert_iname)` compounds:

* Most-DILI-Concern: `r length(most_concern_drugs)`
* Less-DILI-Concern: `r length(less_concern_drugs)`
* No-DILI-Concern: `r length(no_concern_drugs)`

```{r}
# Subset the GCT object by Most-DILI-Concern drugs
id_most <- which(gct@cdesc$pert_iname %in% most_less_concern_drugs)
gct_most <- subset.gct(gct, cid=id_most)
# Subset the GCT object by No-DILI-Concern drugs
id_no <- which(gct@cdesc$pert_iname %in% no_concern_drugs)
gct_no <- subset.gct(gct, cid=id_no)
```


## Subset across specific cell lines

We will subset across the following cell lines:

* A375, FIBRNPC (skin)
* A549, HCC515 (lung)
* BT20, HS578T, MCF10A, MCF7, MDAMB231, SKBR3 (breast)
* HA1E, HEK293T, NKDBA (kidney)
* HEPG2, PHH (liver)
* HT29, SW480 (large intestine)


```{r}
# Cell lines selected
cell_ids_selected <- c("A375", "FIBRNPC", "A549", "HCC515", "BT20", "HS578T", "MCF10A", "MCF7", "MDAMB231", "SKBR3", "HA1E", "HEK293T", "NKDBA", "HEPG2", "PHH", "HT29", "SW480")
# Subset the GCT object by Most-DILI-Concern drugs
id_cell_most <- which(gct_most@cdesc$cell_id %in% cell_ids_selected)
gct_cell_most <- subset.gct(gct_most, cid=id_cell_most)
# Subset the GCT object by No-DILI-Concern drugs
id_cell_no <- which(gct_no@cdesc$cell_id %in% cell_ids_selected)
gct_cell_no <- subset.gct(gct_no, cid=id_cell_no)
```


## Compare the expression of each gene across samples of Most-DILI-Concern vs. No-DILI-Concern in all cell lines, 10 µM and 24 h

Among samples from Most-DILI-Concern drugs, there are `r length(gct_cell_most@cid)` samples. These samples have different doses and times:

```{r}
table(gct_cell_most@cdesc$pert_idose, gct_cell_most@cdesc$pert_itime)
```

Same happens with No-DILI-Concern drugs, with `r length(gct_cell_no@cid)` samples in different doses and times:

```{r}
table(gct_cell_no@cdesc$pert_idose, gct_cell_no@cdesc$pert_itime)
```

We will use 10 µM and 24 h, as it is clearly one of the conditions with more samples, and with 24 h the treatment has enough time to produce an effect on the cell.

```{r}
# Subset the samples from Most-DILI-Concern drugs by 10 µM and 24 h
id_most_10_24 <- which(gct_cell_most@cdesc$pert_idose == "10 µM" & gct_cell_most@cdesc$pert_itime == "24 h")
gct_most_10_24 <- subset.gct(gct_cell_most, cid=id_most_10_24)
# Subset the samples from No-DILI-Concern drugs by 10 µM and 24 h
id_no_10_24 <- which(gct_cell_no@cdesc$pert_idose == "10 µM" & gct_cell_no@cdesc$pert_itime == "24 h")
gct_no_10_24 <- subset.gct(gct_cell_no, cid=id_no_10_24)
```

Now, for each gene, we will check the difference of expression between Most-DILI-Concern drugs and No-DILI-Concern drugs using a Wilcoxon rank-sum test (or Mann-Whitney U test) ([More info](https://stat.ethz.ch/R-manual/R-devel/library/stats/html/wilcox.test.html)).

```{r}
# Create new dataframe to store the results
cols <- c("gene_id", "landmark", "statistic", "p.value")
wilcox_df <- data.frame(matrix(ncol = length(cols), nrow=0))
colnames(wilcox_df) <- cols

# Calculate the wilcoxon for each gene and store the results
#output_table <- "/home/quim/PHD/Projects/camda/results/gene_test_spec_10_24.tsv"
output_table <- "/home/quim/PHD/Projects/camda/results/gene_test_landmark_spec_10_24_mixlessmost.tsv"
if(!file.exists(output_table)){
  #for (gene_id in gct_most_10_24@rid) {
  for (gene_id in landmark_genes) {
    most_expr <- gct_most_10_24@mat[gct_most_10_24@rid == gene_id]
    no_expr <- gct_no_10_24@mat[gct_no_10_24@rid == gene_id]
    res <- wilcox.test(most_expr, no_expr, alternative = "two.sided", paired = FALSE)
    landmark <- gene_id %in% landmark_genes
    wilcox_df[nrow(wilcox_df)+1,] <- c(gene_id, landmark, res$statistic, res$p.value)
  }
  wilcox_df$p.adjust <- p.adjust(wilcox_df$p.value, "BH")
  write.table(wilcox_df, file = output_table,row.names=FALSE, na="-",col.names=TRUE, sep="\t")
}else{
  wilcox_df = read.csv(output_table, header = TRUE, sep = "\t")
}
head(wilcox_df)
```

Among the `r length(wilcox_df$gene_id)` genes, there are `r length(wilcox_df$gene_id[wilcox_df$p.adjust<0.05])` genes with an adjusted p-value under 0.05 and `r length(wilcox_df$gene_id[wilcox_df$p.adjust<0.01])` under 0.01. 

Focusing only on the `r length(wilcox_df$gene_id[wilcox_df$landmark==TRUE])` landmark genes, there are `r length(wilcox_df$gene_id[wilcox_df$p.adjust<0.05 & wilcox_df$landmark==TRUE])` genes with a p-value under 0.05 and `r length(wilcox_df$gene_id[wilcox_df$p.adjust<0.01 & wilcox_df$landmark==TRUE])` under 0.01.

We will make a heatmap to plot the expression of the genes for each drug.

```{r}
# Define the genes found
all_wilcox_gene_ids <- unique(wilcox_df$gene_id[wilcox_df$p.adjust<0.01])
landmark_wilcox_gene_ids <- unique(wilcox_df$gene_id[wilcox_df$p.adjust<0.0001 & wilcox_df$landmark==TRUE])
top100_wilcox_gene_ids <- unique(wilcox_df$gene_id[wilcox_df$p.adjust<0.0001 & wilcox_df$landmark==TRUE])

# Get a vector of gene symbols ordered equal to the vector of gene IDs
genes_selected <- landmark_wilcox_gene_ids
genes_df <- data.frame(1:length(genes_selected), genes_selected)
colnames(genes_df)<- c("id", "pr_gene_id")
genes_df <- merge(genes_df, gene_info_df[,c("pr_gene_id", "pr_gene_symbol")], by="pr_gene_id")
genes_df <- genes_df[order(genes_df$id), ]
genes_df$id <- NULL

# Create new dataframe to store the matrix
cols <- c(most_concern_drugs, no_concern_drugs)
rows <- genes_df$pr_gene_symbol
heat_df <- data.frame(matrix(ncol = length(cols), nrow=length(rows)))
colnames(heat_df) <- cols
rownames(heat_df) <- rows
gene_ids <- genes_df$pr_gene_id

# Introduce the data in the matrix
for (drug in most_concern_drugs){
  id_drug <- which(gct_most_10_24@cdesc$pert_iname == drug)
  id_genes <- which(gct_most_10_24@rid %in% gene_ids)
  gct_drug <- subset.gct(gct_most_10_24, cid=id_drug, rid=id_genes)
  #means<- rowMeans(gct_drug@mat)
  medians <- apply(gct_drug@mat, 1, median) 
  heat_df[drug] <- medians
}
for (drug in no_concern_drugs){
  id_drug <- which(gct_no_10_24@cdesc$pert_iname == drug)
  id_genes <- which(gct_no_10_24@rid %in% gene_ids)
  gct_drug <- subset.gct(gct_no_10_24, cid=id_drug, rid=id_genes)
  #means<- rowMeans(gct_drug@mat)
  medians <- apply(gct_drug@mat, 1, median) 
  heat_df[drug] <- medians
}
#heatmap(as.matrix(heat_df), Colv = NA, Rowv = NA, scale="column")
#heatmap.2(as.matrix(heat_df), col=bluered, Colv = NA, Rowv = NA, scale="row", trace="none")
#heatmap.2(as.matrix(heat_df), col=bluered, Colv = NA, Rowv = NA, scale="none", trace="none") #no scale means we use the raw z-scores

cc <- c(rep("green", times=length(most_concern_drugs)), rep("yellow", times=length(no_concern_drugs)))
cc2 <- c(rep("#004f00", times=length(most_concern_drugs)), rep("#9a9a00", times=length(no_concern_drugs)))
heatmap.2(as.matrix(heat_df), col=bluered, Colv = NA, Rowv = NA, scale="none", trace="none", ColSideColors=cc, colCol=cc2) #no scale means we use the raw z-scores

#annotation <- HeatmapAnnotation(df = data.frame(type = type))
#Heatmap(heat_df, name = "expression", km = 0, col = colorRamp2(c(min(heat_df), 0, max(heat_df)), c("blue", "white", "red")), top_annotation = annotation, cluster_rows=FALSE, cluster_columns=FALSE)
```

We will read the file containing the DisGeNET genes for each DILI-related phenotype:

```{r}
phenotype2gene <- read.csv(phenotype2gene_file, header=TRUE, sep="\t")
```

We will check the overlap between DisGeNET genes and the genes identified by the Wilcoxon test for each DILI-related phenotype:

```{r}
# Define the phenotypes
phenotypes <- unique(phenotype2gene$diseaseid)
curated_phenotypes <- unique(phenotype2gene$diseaseid[phenotype2gene$source == "CURATED"])

# Create new dataframe to store the results
cols <- c("phenotype", "source", "landmark", "cutoff", "intersection")
intersect_df <- data.frame(matrix(ncol = length(cols), nrow=0))
colnames(intersect_df) <- cols

# Check the intersection between the genes found by wilcoxon and by DisGeNET
for (phenotype in phenotypes){
  curated_gene_ids <-unique(phenotype2gene$geneid[phenotype2gene$diseaseid==phenotype & phenotype2gene$source=="CURATED"])
  all_gene_ids <- unique(phenotype2gene$geneid[phenotype2gene$diseaseid==phenotype & phenotype2gene$source=="ALL"])
  intersect_df[nrow(intersect_df)+1,] <- c(phenotype, "CURATED", FALSE, 0.01, length(intersect(all_wilcox_gene_ids, curated_gene_ids)))
  intersect_df[nrow(intersect_df)+1,] <- c(phenotype, "ALL", FALSE, 0.01, length(intersect(all_wilcox_gene_ids, all_gene_ids)))
  intersect_df[nrow(intersect_df)+1,] <- c(phenotype, "CURATED", TRUE, 0.01, length(intersect(landmark_wilcox_gene_ids, curated_gene_ids)))
  intersect_df[nrow(intersect_df)+1,] <- c(phenotype, "ALL", TRUE, 0.01, length(intersect(landmark_wilcox_gene_ids, all_gene_ids)))
}

output_table <- "/home/quim/PHD/Projects/camda/results/gene_test_all_10_24_intersection.tsv"
write.table(intersect_df, file = output_table,row.names=FALSE, na="-",col.names=TRUE, sep="\t")
head(intersect_df)

```
