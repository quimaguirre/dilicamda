---
title: "CMap Drug Safety Challenge: Landmark genes"
author: "Joaquim Aguirre-Plans"
date: "March 28, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
### Install packages ###
# Install Bioconductor to install "rhdf5", a dependency of cmapR
#install.packages("BiocManager")
#BiocManager::install("rhdf5", version = "3.8")
# cmapR has been installed manually by downloading the package on github (https://github.com/cmap/cmapR) and running the following commands:
# R CMD build cmapR
# R CMD check cmapR_1.0.1.tar.gz
#install.packages("/home/quim/R/x86_64-pc-linux-gnu-library/3.5/cmapR_1.0.1.tar.gz", type="source", repos=NULL)
# Install GGPlot2 and its dependencies
#install.packages('Rcpp', dependencies = TRUE)
#install.packages('ggplot2', dependencies = TRUE)
#install.packages('data.table', dependencies = TRUE)
# Install ggbiplot to plot the PCA
#library(devtools)
#install_github("vqv/ggbiplot")

### Load packages ###
library(cmapR)
library(ggplot2)
library(ggbiplot)
```

```{r, include=FALSE}
### Define files ###
#setwd("/sbi/users/interchange/emre/quim/camda")
drugs_file <- "/home/quim/PHD/Projects/camda/camda_data/CAMDA_l1000_1314compounds-pert_iname.rda"
drug_info_file <- "/sbi/users/interchange/emre/quim/camda/CAMDA_l1000_1314compounds-info.rda"
dilirank_file <- "/home/quim/PHD/Projects/camda/camda_data/CAMDA_l1000_1314compounds-dilirank.v2.rda"
expression_file <- "/sbi/users/interchange/emre/quim/camda/CAMDA_l1000_1314compounds-GSE92742_Level5_gct.rda"
landmark_genes_file <- "/home/quim/PHD/Projects/camda/additional_data/GSE92742_Broad_LINCS_gene_info_delta_landmark.txt"
```


## Load files

First I load the files and explore the objects loaded

```{r}
load(drugs_file)
load(drug_info_file)
load(dilirank_file)
load(expression_file) # Requires cmapR
```

## Retrieve Landmark Genes and subset gene expression data

```{r}
landmark_df <- read.csv(landmark_genes_file, header=TRUE, sep="\t") # Read table
landmark_genes <- landmark_df$pr_gene_id # Get gene IDs

# Subset landmark genes
idland <- which(gct@rid %in% landmark_genes)
gctland <- subset.gct(gct, rid=idland)
```

Among the `r length(gct@rid)` All Inferred Genes there are `r length(gctland@rid)` Landmark genes. [More info](https://clue.io/connectopedia/l1000_gene_space)


## Subset the gene expression data by specific conditions

There are three relevant parameters if we want to subset the gene expression data of a given drug:

* cell_id: The type of cell line
* pert_idose: The quantity of drug dose
* pert_itime: The duration of drug dose

We will try to analyse the similarity in the expression of the genes comparing the pairs of drugs of the different DILIrank groups. We will choose specific conditions:

* **Cell ID**: HEPG2
* **Dose**: 10 µM
* **Time**: 6 h


```{r}
# Conditions
cell_id <- "HEPG2"
dose <- "10 µM"
time <- "6 h"


# Create new dataframe to store gene expression values for pca
pca_df <- data.frame(matrix(ncol = length(gctland@rid), nrow = length(drank.sel$pert_iname)))
colnames(pca_df) <- gctland@rid
rownames(pca_df) <- drank.sel$pert_iname

# Iterate over each drug and subset by the conditions defined
for (drug in drank.sel$pert_iname){
  # Get the subset of samples of the drug
  idx <- which(gctland@cdesc$pert_iname==drug)
  x <- subset.gct(gctland, cid=idx) # Subset by drug
  idx_c <- which(x@cdesc$cell_id==cell_id)
  x_c <- subset.gct(x, cid=idx_c) # Subset by cell ID
  idx_cd <- which(x_c@cdesc$pert_idose==dose)
  x_cd <- subset.gct(x_c, cid=idx_cd) # Subset by dose
  idx_cdt <- which(x_cd@cdesc$pert_itime==time)
  x_cdt <- subset.gct(x_cd, cid=idx_cdt) # Subset by time
  #print(paste(drug,length(x_cdt@cid)))
  if (length(x_cdt@cid) > 0){
    pca_df[drug,] <- rowMeans(x_cdt@mat)
  } else {
    pca_df[drug] <- NULL
  }
}

```

Calculate the PCA:

```{r}
# Define the groups of the drugs
groups <- c()
drugs <- rownames(pca_df)
for (i in 1:length(drugs)){
  drug <- drugs[i]
  groups[i] <- drank.sel$DILIConcern[drank.sel$pert_iname==drug]
}
# Calculate the PCA
pca_df <- pca_df[rowSums(is.na(pca_df)) != ncol(pca_df), ]
cmapdata.pca <- prcomp(pca_df, center = TRUE,scale. = TRUE)
#summary(cmapdata.pca)

# Plot the PCA
ggbiplot(cmapdata.pca,ellipse=TRUE,var.axes=FALSE, groups=groups)
```

